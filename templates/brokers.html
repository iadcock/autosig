{% extends "base.html" %}
{% block title %}Brokers - Trading Bot{% endblock %}

{% block content %}
<div class="card">
    <h3 class="card-title">Market Session</h3>
    <p class="text-muted mb-2">Current market status determines smoke test mode.</p>
    
    <div class="stat-row" style="display: flex; gap: 20px; align-items: center;">
        <div class="stat-box" style="max-width: 200px;">
            <div class="stat-value" id="market-status">--</div>
            <div class="stat-label">Market Status</div>
        </div>
        <div class="stat-box" style="max-width: 200px;">
            <div class="stat-value" id="smoke-mode">--</div>
            <div class="stat-label">Smoke Test Mode</div>
        </div>
    </div>
    
    <p class="text-muted mt-2" id="mode-help" style="font-size: 0.9em;">
        <strong>FILL mode</strong>: Tests real order fills during market hours.<br>
        <strong>NO-FILL mode</strong>: Tests order placement and cancellation when market is closed.
    </p>
</div>

<div class="card">
    <h3 class="card-title">Whop Alerts</h3>
    <p class="text-muted mb-2">Test connectivity to Whop alerts feed and verify authentication.</p>
    
    <div class="btn-row">
        <button id="btn-whop-health" class="btn btn-sm" onclick="runHealthCheck('whop')">
            Health Check
        </button>
    </div>
    
    <div id="results-whop" class="mt-2 hidden"></div>
</div>

<div class="grid-2">
    <div class="card">
        <h3 class="card-title">Alpaca (Paper Trading)</h3>
        <p class="text-muted mb-2">Test connectivity to Alpaca paper trading API.</p>
        
        <div class="btn-row">
            <button id="btn-alpaca-health" class="btn btn-sm" onclick="runHealthCheck('alpaca')">
                Health Check
            </button>
            <button id="btn-alpaca-smoke" class="btn btn-sm btn-secondary" onclick="runSmokeTest('alpaca')">
                Run Smoke Test
            </button>
        </div>
        
        <div id="results-alpaca" class="mt-2 hidden"></div>
    </div>
    
    <div class="card">
        <h3 class="card-title">Tradier (Sandbox)</h3>
        <p class="text-muted mb-2">Test connectivity to Tradier sandbox API.</p>
        
        <div class="btn-row">
            <button id="btn-tradier-health" class="btn btn-sm" onclick="runHealthCheck('tradier')">
                Health Check
            </button>
            <button id="btn-tradier-smoke" class="btn btn-sm btn-secondary" onclick="runSmokeTest('tradier')">
                Run Smoke Test
            </button>
        </div>
        
        <div id="results-tradier" class="mt-2 hidden"></div>
    </div>
</div>

<div class="card">
    <h3 class="card-title">Paper Mirror Status</h3>
    <p class="text-muted mb-2">When enabled, paper trades are executed on both Alpaca and Tradier.</p>
    
    <div class="stat-box" style="max-width: 200px;">
        <div class="stat-value" id="mirror-status">--</div>
        <div class="stat-label">Paper Mirror</div>
    </div>
    
    <p class="text-muted mt-2">Configure in <a href="/settings">Settings</a></p>
</div>

<div class="card">
    <h3 class="card-title">Environment Debug</h3>
    <p class="text-muted mb-2">Check which environment variables are detected.</p>
    
    <button id="btn-debug-env" class="btn btn-sm btn-gray" onclick="checkEnvDebug()">
        Check Environment
    </button>
    
    <div id="env-results" class="mt-2 hidden"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadMarketSession() {
    try {
        const data = await fetchJSON('/market/session');
        
        const marketStatus = document.getElementById('market-status');
        const smokeMode = document.getElementById('smoke-mode');
        
        if (data.is_open) {
            marketStatus.textContent = 'OPEN';
            marketStatus.className = 'stat-value result-ok';
        } else {
            marketStatus.textContent = 'CLOSED';
            marketStatus.className = 'stat-value result-warn';
        }
        
        const mode = data.smoke_test_mode || 'UNKNOWN';
        smokeMode.textContent = mode;
        if (mode === 'FILL') {
            smokeMode.className = 'stat-value result-ok';
        } else if (mode === 'NO_FILL') {
            smokeMode.className = 'stat-value result-warn';
        } else {
            smokeMode.className = 'stat-value';
        }
    } catch (error) {
        console.error('Failed to load market session:', error);
        document.getElementById('market-status').textContent = 'ERROR';
        document.getElementById('smoke-mode').textContent = 'UNKNOWN';
    }
}

async function loadMirrorStatus() {
    try {
        const config = await fetchJSON('/config');
        const enabled = config.paper_mirror_enabled;
        document.getElementById('mirror-status').textContent = enabled ? 'ENABLED' : 'DISABLED';
        document.getElementById('mirror-status').className = 'stat-value ' + (enabled ? 'result-ok' : 'result-warn');
    } catch (error) {
        console.error('Failed to load config:', error);
    }
}

async function runHealthCheck(broker) {
    const btn = document.getElementById(`btn-${broker}-health`);
    const results = document.getElementById(`results-${broker}`);
    
    showSpinner(btn, 'Checking...');
    show(results);
    results.innerHTML = '<p class="text-muted">Running health check...</p>';
    
    try {
        const data = await postJSON(`/health/${broker}`, {});
        results.innerHTML = buildResultsTable(data.steps || []);
        if (data.success) {
            showSuccess(btn, 'Done!');
        } else {
            showError(btn, 'Failed');
        }
        refreshStatusRow();
    } catch (error) {
        results.innerHTML = '<p class="result-fail">Health check failed</p>';
        showError(btn, 'Error');
    }
}

async function runSmokeTest(broker) {
    const btn = document.getElementById(`btn-${broker}-smoke`);
    const results = document.getElementById(`results-${broker}`);
    
    showSpinner(btn, 'Testing...');
    show(results);
    results.innerHTML = '<p class="text-muted">Running smoke test (may take 30+ seconds)...</p>';
    
    try {
        const data = await postJSON(`/smoke/${broker}`, {});
        
        let modeLabel = '';
        if (data.mode) {
            modeLabel = `<div class="smoke-mode-badge ${data.mode === 'FILL' ? 'mode-fill' : 'mode-nofill'}">${data.mode} MODE</div>`;
        }
        
        let warningsHtml = '';
        if (data.warnings && data.warnings.length > 0) {
            warningsHtml = '<div class="smoke-warnings"><strong>Warnings:</strong><ul>';
            for (const warning of data.warnings) {
                warningsHtml += `<li>${escapeHtml(warning)}</li>`;
            }
            warningsHtml += '</ul></div>';
        }
        
        results.innerHTML = modeLabel + buildResultsTable(data.steps || []) + warningsHtml;
        
        if (data.success) {
            showSuccess(btn, `Passed (${data.mode})`);
        } else {
            showError(btn, `Failed (${data.mode})`);
        }
        refreshStatusRow();
    } catch (error) {
        results.innerHTML = '<p class="result-fail">Smoke test failed</p>';
        showError(btn, 'Error');
    }
}

async function checkEnvDebug() {
    const btn = document.getElementById('btn-debug-env');
    const results = document.getElementById('env-results');
    
    showSpinner(btn, 'Checking...');
    show(results);
    
    try {
        const data = await fetchJSON('/debug/env');
        
        let html = '<table class="table"><thead><tr><th>Variable</th><th>Status</th></tr></thead><tbody>';
        for (const [key, info] of Object.entries(data)) {
            const statusClass = info.detected ? 'result-ok' : 'result-fail';
            const statusText = info.detected ? 'Detected' : 'Missing';
            html += `<tr><td>${escapeHtml(key)}</td><td class="${statusClass}">${statusText}</td></tr>`;
        }
        html += '</tbody></table>';
        
        results.innerHTML = html;
        showSuccess(btn, 'Done!');
    } catch (error) {
        results.innerHTML = '<p class="result-fail">Failed to check environment</p>';
        showError(btn, 'Error');
    }
}

loadMarketSession();
loadMirrorStatus();
</script>

<style>
.smoke-mode-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.85em;
    margin-bottom: 10px;
}
.mode-fill {
    background-color: #d4edda;
    color: #155724;
}
.mode-nofill {
    background-color: #fff3cd;
    color: #856404;
}
.smoke-warnings {
    margin-top: 10px;
    padding: 10px;
    background-color: #fff3cd;
    border-radius: 4px;
    font-size: 0.9em;
}
.smoke-warnings ul {
    margin: 5px 0 0 20px;
    padding: 0;
}
</style>
{% endblock %}
