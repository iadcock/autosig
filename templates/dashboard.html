{% extends "base.html" %}
{% block title %}Dashboard - Trading Bot{% endblock %}

{% block content %}
<div class="card">
    <h3 class="card-title">Paper Replay Mode</h3>
    <div class="stat-box">
        <div class="stat-value" id="auto-mode-status">--</div>
        <div class="stat-label">Replay Status</div>
    </div>
    <div class="text-center mt-2 text-muted" style="font-size: 12px;">
        PAPER MODE • SIGNAL-BASED REPLAY • LEARNING ONLY
    </div>
</div>

<div class="card">
    <h3 class="card-title">Paper Replay Status</h3>
    <div class="grid-3">
        <div class="stat-box">
            <div class="stat-value" id="signals-today">0</div>
            <div class="stat-label">Signals Today</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="open-positions">0</div>
            <div class="stat-label">Open Paper Positions</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="executable-signals">0</div>
            <div class="stat-label">Executable Signals</div>
        </div>
    </div>
</div>

<div class="card">
    <h3 class="card-title">Last Action</h3>
    <div id="last-action">
        <p class="text-muted">No recent actions</p>
    </div>
</div>

<div class="card">
    <h3 class="card-title">Quick Links</h3>
    <div class="btn-row">
        <a href="/feed" class="btn btn-sm">Signal Feed</a>
        <a href="/replay" class="btn btn-sm">Daily Replay</a>
        <a href="/signal-review" class="btn btn-sm btn-gray">Signal Review</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoModeEnabled = false;

async function loadDashboardData() {
    try {
        const autoStatus = await fetchJSON('/auto/status');
        autoModeEnabled = autoStatus.enabled || false;
        
        document.getElementById('auto-mode-status').textContent = autoModeEnabled ? 'ENABLED' : 'DISABLED';
        document.getElementById('auto-mode-status').className = 'stat-value ' + (autoModeEnabled ? 'result-ok' : 'result-warn');
        
        document.getElementById('signals-today').textContent = autoStatus.signals_today || 0;
        
        // Paper mode doesn't require market window status
        
    } catch (error) {
        console.error('Failed to load dashboard data:', error);
    }
    
    try {
        // Load open positions and executable signals count
        const feedData = await fetchJSON('/api/signals/feed');
        if (feedData.signals) {
            const openPositions = feedData.signals.filter(s => s.position_status === 'OPEN_PAPER').length;
            document.getElementById('open-positions').textContent = openPositions;
            
            const executableCount = feedData.signals.filter(s => s.certainty_level === 'EXECUTABLE').length;
            document.getElementById('executable-signals').textContent = executableCount;
        }
    } catch (error) {
        console.error('Failed to load signal data:', error);
    }
}

async function toggleAutoMode() {
    const btn = document.getElementById('btn-toggle-auto');
    showSpinner(btn, 'Toggling...');
    
    try {
        const result = await postJSON('/auto/toggle', { enabled: !autoModeEnabled });
        autoModeEnabled = result.enabled;
        showSuccess(btn, autoModeEnabled ? 'Enabled!' : 'Disabled!');
        loadDashboardData();
    } catch (error) {
        showError(btn, 'Error');
    }
}

loadDashboardData();
setInterval(loadDashboardData, 30000);
</script>
{% endblock %}
