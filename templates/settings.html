{% extends "base.html" %}
{% block title %}Settings - Trading Bot{% endblock %}

{% block content %}
<div id="live-mode-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3 class="modal-title"><span id="modal-mode-title">Enable LIVE Trading</span></h3>
        <div class="modal-body">
            <p><strong>Warning:</strong> You are about to enable <span id="modal-mode-name">LIVE</span> mode. This will execute trades with <strong>REAL MONEY</strong>.</p>
            
            <div class="modal-env-status">
                <div class="modal-env-row">
                    <span class="modal-env-key">LIVE_TRADING</span>
                    <span class="modal-env-value" id="modal-env-live">--</span>
                </div>
                <div class="modal-env-row">
                    <span class="modal-env-key">DRY_RUN</span>
                    <span class="modal-env-value" id="modal-env-dry">--</span>
                </div>
                <div class="modal-env-row" id="modal-dual-row" style="display: none;">
                    <span class="modal-env-key">ALLOW_DUAL_MODE</span>
                    <span class="modal-env-value" id="modal-env-dual">--</span>
                </div>
            </div>
            
            <div class="modal-confirm-section">
                <div class="modal-confirm-label">Type confirmation to proceed:</div>
                <div class="modal-confirm-hint">Type "<span id="modal-confirm-phrase">ENABLE LIVE</span>" exactly</div>
                <input type="text" id="modal-confirm-input" class="modal-confirm-input" placeholder="Type here..." autocomplete="off">
            </div>
        </div>
        <div class="modal-buttons">
            <button type="button" class="modal-btn modal-btn-cancel" onclick="cancelModeModal()">Cancel</button>
            <button type="button" id="modal-confirm-btn" class="modal-btn modal-btn-confirm" disabled onclick="confirmModeModal()">Enable</button>
        </div>
    </div>
</div>

<div id="settings-warnings" class="warnings-container" style="display: none;"></div>

<div class="card">
    <h3 class="card-title">Trading Settings</h3>
    <p class="text-muted mb-3">Configure trading parameters. Changes are saved and persist across restarts.</p>
    
    <form id="settings-form">
        <div class="form-group">
            <label class="form-label">Execution Mode</label>
            <select id="setting-execution-mode" name="REQUESTED_EXECUTION_MODE" class="form-input">
                <option value="paper">Paper - Simulated trading only (safe)</option>
                <option value="live">Live - Real money trading (requires LIVE_TRADING=true)</option>
                <option value="dual">Dual - Live trading + paper mirror (requires ALLOW_DUAL_MODE=true)</option>
            </select>
            <p class="text-muted" style="font-size: 12px; margin-top: 4px;">Paper is always safe. Live and Dual require environment flags to be enabled.</p>
            <p id="mode-effective-msg" class="text-muted" style="font-size: 12px; margin-top: 4px; font-style: italic;"></p>
        </div>
        
        <div class="form-group">
            <label class="form-label">Risk Mode</label>
            <div class="locked-setting">
                <span class="locked-badge">AGGRESSIVE</span>
                <span class="locked-label">(locked for testing)</span>
            </div>
            <input type="hidden" id="setting-risk-mode" name="RISK_MODE" value="aggressive">
            <p class="text-muted" style="font-size: 12px; margin-top: 4px;">All trade types allowed, 5% max risk, 5 trades/hour. This is temporarily locked during execution testing.</p>
        </div>
        
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Paper Mirror Enabled</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-paper-mirror" name="PAPER_MIRROR_ENABLED">
                    <span class="toggle-slider"></span>
                </label>
                <p class="text-muted" style="font-size: 12px; margin-top: 4px;">Execute paper trades on both brokers</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Allow 0DTE SPX</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-0dte" name="ALLOW_0DTE_SPX">
                    <span class="toggle-slider"></span>
                </label>
                <p class="text-muted" style="font-size: 12px; margin-top: 4px;">Allow same-day expiration SPX trades (Aggressive mode only)</p>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Auto Poll Interval (seconds)</label>
                <input type="number" id="setting-poll" name="AUTO_POLL_SECONDS" class="form-input" min="10" max="300">
            </div>
            
            <div class="form-group">
                <label class="form-label">Window Buffer (minutes)</label>
                <input type="number" id="setting-buffer" name="AUTO_WINDOW_BUFFER_MINUTES" class="form-input" min="0" max="120">
            </div>
        </div>
        
        <div class="grid-3">
            <div class="form-group">
                <label class="form-label">Max Risk % Per Trade</label>
                <input type="number" id="setting-risk-trade" name="MAX_RISK_PCT_PER_TRADE" class="form-input" min="1" max="10">
            </div>
            
            <div class="form-group">
                <label class="form-label">Max Daily Risk %</label>
                <input type="number" id="setting-risk-daily" name="MAX_DAILY_RISK_PCT" class="form-input" min="1" max="50">
            </div>
            
            <div class="form-group">
                <label class="form-label">Max Open Positions</label>
                <input type="number" id="setting-positions" name="MAX_OPEN_POSITIONS" class="form-input" min="1" max="100">
            </div>
        </div>
        
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Max Trades Per Day</label>
                <input type="number" id="setting-trades-day" name="AUTO_MAX_TRADES_PER_DAY" class="form-input" min="1" max="50">
            </div>
            
            <div class="form-group">
                <label class="form-label">Max Trades Per Hour</label>
                <input type="number" id="setting-trades-hour" name="AUTO_MAX_TRADES_PER_HOUR" class="form-input" min="1" max="20">
            </div>
        </div>
        
        <div class="btn-row mt-3">
            <button type="submit" id="btn-save" class="btn">Save Settings</button>
            <button type="button" id="btn-reset" class="btn btn-gray" onclick="resetSettings()">Reset to Defaults</button>
        </div>
        
        <div id="effective-behavior" class="effective-behavior-box" style="display: none;">
            <h4>Effective Behavior</h4>
            <div id="behavior-summary" class="effective-behavior-text"></div>
            <div id="behavior-warnings"></div>
        </div>
    </form>
</div>

<div class="card">
    <h3 class="card-title">Safety Status</h3>
    <div class="grid-3">
        <div class="stat-box">
            <div class="stat-value" id="live-trading-status">--</div>
            <div class="stat-label">Live Trading</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="dry-run-status">--</div>
            <div class="stat-label">Dry Run Mode</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="auto-mode-status">--</div>
            <div class="stat-label">Auto Mode</div>
        </div>
    </div>
    <p class="text-muted text-center mt-2">These settings are controlled by environment variables and cannot be changed here.</p>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateEffectiveBehavior(behavior) {
    if (!behavior) return;
    
    const box = document.getElementById('effective-behavior');
    const summary = document.getElementById('behavior-summary');
    const warningsEl = document.getElementById('behavior-warnings');
    
    if (box && summary) {
        box.style.display = 'block';
        summary.textContent = behavior.summary_text || '';
        
        warningsEl.innerHTML = '';
        if (behavior.warnings && behavior.warnings.length > 0) {
            behavior.warnings.forEach(w => {
                const div = document.createElement('div');
                div.className = w.includes('LIVE') ? 'behavior-danger' : 'behavior-warning';
                div.textContent = w;
                warningsEl.appendChild(div);
            });
        }
    }
}

function showSettingsWarnings(warnings) {
    const container = document.getElementById('settings-warnings');
    if (!container) return;
    
    if (!warnings || warnings.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.innerHTML = '';
    warnings.forEach(w => {
        const div = document.createElement('div');
        div.className = 'warning-item';
        div.textContent = w;
        container.appendChild(div);
    });
    container.style.display = 'block';
    
    setTimeout(() => {
        container.style.display = 'none';
    }, 10000);
}

async function loadSettings() {
    try {
        const settings = await fetchJSON('/api/settings');
        
        const execMode = settings.REQUESTED_EXECUTION_MODE || 'paper';
        document.getElementById('setting-execution-mode').value = execMode;
        if (typeof previousModeValue !== 'undefined') {
            previousModeValue = execMode;
        }
        document.getElementById('setting-paper-mirror').checked = settings.PAPER_MIRROR_ENABLED || false;
        document.getElementById('setting-0dte').checked = settings.ALLOW_0DTE_SPX || false;
        document.getElementById('setting-poll').value = settings.AUTO_POLL_SECONDS || 30;
        document.getElementById('setting-buffer').value = settings.AUTO_WINDOW_BUFFER_MINUTES || 60;
        document.getElementById('setting-risk-trade').value = settings.MAX_RISK_PCT_PER_TRADE || 2;
        document.getElementById('setting-risk-daily').value = settings.MAX_DAILY_RISK_PCT || 10;
        document.getElementById('setting-positions').value = settings.MAX_OPEN_POSITIONS || 20;
        document.getElementById('setting-trades-day').value = settings.AUTO_MAX_TRADES_PER_DAY || 10;
        document.getElementById('setting-trades-hour').value = settings.AUTO_MAX_TRADES_PER_HOUR || 3;
        
        if (settings.effective_behavior) {
            updateEffectiveBehavior(settings.effective_behavior);
        }
        
    } catch (error) {
        console.error('Failed to load settings:', error);
    }
    
    try {
        const modeInfo = await fetchJSON('/mode');
        const msgEl = document.getElementById('mode-effective-msg');
        if (msgEl && modeInfo) {
            msgEl.textContent = modeInfo.message || '';
            if (modeInfo.effective !== modeInfo.requested) {
                msgEl.style.color = '#dc3545';
            } else {
                msgEl.style.color = '#28a745';
            }
        }
    } catch (error) {
        console.error('Failed to load mode info:', error);
    }
    
    try {
        const config = await fetchJSON('/config');
        
        const liveEl = document.getElementById('live-trading-status');
        const behavior = await fetchJSON('/api/settings').then(s => s.effective_behavior);
        const liveActive = behavior && behavior.live_trading_active;
        liveEl.textContent = liveActive ? 'ACTIVE' : (config.live_trading ? 'ENABLED' : 'DISABLED');
        liveEl.className = 'stat-value ' + (liveActive ? 'result-fail' : (config.live_trading ? 'result-warn' : 'result-ok'));
        
        const autoEl = document.getElementById('auto-mode-status');
        autoEl.textContent = config.auto_mode_enabled ? 'ENABLED' : 'DISABLED';
        autoEl.className = 'stat-value ' + (config.auto_mode_enabled ? 'result-warn' : 'result-ok');
        autoEl.title = 'Auto mode always runs PAPER-only unless AUTO_LIVE_ENABLED=true';
        
        const dryRunEl = document.getElementById('dry-run-status');
        if (config.dry_run === false && config.live_trading) {
            dryRunEl.textContent = 'OFF (LIVE)';
            dryRunEl.className = 'stat-value result-fail';
        } else {
            dryRunEl.textContent = config.dry_run ? 'ON' : 'OFF';
            dryRunEl.className = 'stat-value ' + (config.dry_run ? 'result-ok' : 'result-warn');
        }
        
    } catch (error) {
        console.error('Failed to load config:', error);
    }
}


let pendingModeChange = null;
let previousModeValue = 'paper';
let cachedConfig = null;

document.getElementById('setting-execution-mode').addEventListener('change', async function(e) {
    const newMode = this.value;
    
    if (newMode === 'paper') {
        if (previousModeValue !== 'paper') {
            previousModeValue = newMode;
            await saveSettingsWithMode('paper');
        }
        return;
    }
    
    this.value = previousModeValue;
    
    pendingModeChange = newMode;
    await showModeModal(newMode);
});

async function showModeModal(mode) {
    const modal = document.getElementById('live-mode-modal');
    const titleEl = document.getElementById('modal-mode-title');
    const nameEl = document.getElementById('modal-mode-name');
    const phraseEl = document.getElementById('modal-confirm-phrase');
    const inputEl = document.getElementById('modal-confirm-input');
    const confirmBtn = document.getElementById('modal-confirm-btn');
    const dualRow = document.getElementById('modal-dual-row');
    
    const isLive = mode === 'live';
    const phrase = isLive ? 'ENABLE LIVE' : 'ENABLE DUAL';
    
    titleEl.textContent = isLive ? 'Enable LIVE Trading' : 'Enable DUAL Mode';
    nameEl.textContent = mode.toUpperCase();
    phraseEl.textContent = phrase;
    inputEl.value = '';
    inputEl.classList.remove('input-matched');
    confirmBtn.disabled = true;
    dualRow.style.display = isLive ? 'none' : 'flex';
    
    try {
        const config = await fetchJSON('/config');
        cachedConfig = config;
        
        const liveEl = document.getElementById('modal-env-live');
        liveEl.textContent = config.live_trading ? 'true' : 'false';
        liveEl.className = 'modal-env-value ' + (config.live_trading ? 'env-ok' : 'env-fail');
        
        const dryEl = document.getElementById('modal-env-dry');
        const dryOk = config.dry_run === false;
        dryEl.textContent = config.dry_run ? 'true' : 'false';
        dryEl.className = 'modal-env-value ' + (dryOk ? 'env-ok' : 'env-fail');
        
        if (!isLive) {
            const dualEl = document.getElementById('modal-env-dual');
            dualEl.textContent = config.allow_dual_mode ? 'true' : 'false';
            dualEl.className = 'modal-env-value ' + (config.allow_dual_mode ? 'env-ok' : 'env-fail');
        }
    } catch (e) {
        console.error('Failed to fetch config for modal:', e);
    }
    
    modal.style.display = 'flex';
    inputEl.focus();
}

function cancelModeModal() {
    const modal = document.getElementById('live-mode-modal');
    modal.style.display = 'none';
    pendingModeChange = null;
    
    document.getElementById('setting-execution-mode').value = previousModeValue;
}

async function confirmModeModal() {
    const modal = document.getElementById('live-mode-modal');
    const confirmedMode = pendingModeChange;
    
    modal.style.display = 'none';
    
    if (confirmedMode) {
        document.getElementById('setting-execution-mode').value = confirmedMode;
        previousModeValue = confirmedMode;
        pendingModeChange = null;
        
        await saveSettingsWithMode(confirmedMode);
    }
}

async function saveSettingsWithMode(execMode) {
    const btn = document.getElementById('btn-save');
    showSpinner(btn, 'Saving...');
    
    const settings = {
        REQUESTED_EXECUTION_MODE: execMode,
        RISK_MODE: document.getElementById('setting-risk-mode').value || 'balanced',
        PAPER_MIRROR_ENABLED: document.getElementById('setting-paper-mirror').checked,
        ALLOW_0DTE_SPX: document.getElementById('setting-0dte').checked,
        AUTO_POLL_SECONDS: parseInt(document.getElementById('setting-poll').value) || 30,
        AUTO_WINDOW_BUFFER_MINUTES: parseInt(document.getElementById('setting-buffer').value) || 60,
        MAX_RISK_PCT_PER_TRADE: parseInt(document.getElementById('setting-risk-trade').value) || 2,
        MAX_DAILY_RISK_PCT: parseInt(document.getElementById('setting-risk-daily').value) || 10,
        MAX_OPEN_POSITIONS: parseInt(document.getElementById('setting-positions').value) || 20,
        AUTO_MAX_TRADES_PER_DAY: parseInt(document.getElementById('setting-trades-day').value) || 10,
        AUTO_MAX_TRADES_PER_HOUR: parseInt(document.getElementById('setting-trades-hour').value) || 3
    };
    
    try {
        const result = await postJSON('/api/settings', settings);
        if (result.success) {
            showSuccess(btn, 'Saved!');
            
            if (result.warnings && result.warnings.length > 0) {
                showSettingsWarnings(result.warnings);
            }
            
            if (result.effective_behavior) {
                updateEffectiveBehavior(result.effective_behavior);
            }
            
            if (result.forced_changes && Object.keys(result.forced_changes).length > 0) {
                loadSettings();
            }
            
            refreshStatusRow();
        } else {
            showError(btn, 'Failed');
            document.getElementById('setting-execution-mode').value = 'paper';
            previousModeValue = 'paper';
        }
    } catch (error) {
        showError(btn, 'Error');
        document.getElementById('setting-execution-mode').value = 'paper';
        previousModeValue = 'paper';
    }
}

document.getElementById('modal-confirm-input').addEventListener('input', function() {
    const mode = pendingModeChange;
    if (!mode) return;
    const phrase = mode === 'live' ? 'ENABLE LIVE' : 'ENABLE DUAL';
    const matched = this.value.trim().toUpperCase() === phrase;
    
    this.classList.toggle('input-matched', matched);
    document.getElementById('modal-confirm-btn').disabled = !matched;
});

document.getElementById('modal-confirm-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const confirmBtn = document.getElementById('modal-confirm-btn');
        if (!confirmBtn.disabled) {
            confirmModeModal();
        }
    }
});

document.getElementById('settings-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const execMode = document.getElementById('setting-execution-mode').value || 'paper';
    await saveSettingsWithMode(execMode);
});

async function resetSettings() {
    if (!confirm('Reset all settings to defaults?')) return;
    
    const btn = document.getElementById('btn-reset');
    showSpinner(btn, 'Resetting...');
    
    try {
        await postJSON('/api/settings/reset', {});
        showSuccess(btn, 'Reset!');
        loadSettings();
    } catch (error) {
        showError(btn, 'Error');
    }
}

loadSettings();
</script>
{% endblock %}
